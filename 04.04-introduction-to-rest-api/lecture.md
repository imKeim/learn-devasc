<!-- 4.4.1 -->
## API веб-служб REST

На рисунке слева показано клиентское окно и значок компьютера в облаке со словом API. Стрелка идет от клиента к API со словами запрос (HTTP). Другая стрелка под первым типом переходит от облака к клиенту со словами «ответ» (HTTP).

### Модель запроса/ответа REST API

![](./assets/4.4.1.png)
<!-- /courses/devnet/337c1050-b012-11ea-8a1b-c929643d7563/338add60-b012-11ea-8a1b-c929643d7563/assets/9780b2a4-bcc3-11ea-af32-dfde9d560aae.svg -->

API веб-службы REST (REST API) - это программный интерфейс, который обменивается данными по HTTP, соблюдая принципы архитектурного стиля REST.

Чтобы освежить вашу память, шесть принципов архитектурного стиля REST:

1.	Клиент-Сервер
2.	Без сохранения состояния
3.	Кеш
4.	Единый интерфейс
5.	Многоуровневая система
6.	Код по запросу (необязательно)

Поскольку REST API обмениваются данными через HTTP, они используют те же концепции, что и протокол HTTP:

* HTTP-запросы/ответы
* HTTP-глаголы
* Коды состояния HTTP
* Заголовки/тело HTTP

<!-- 4.4.2 -->
## Запросы REST API

### Запросы REST API

Запросы REST API - это, по сути, HTTP-запросы, которые следуют принципам REST. Эти запросы позволяют приложению (клиенту) попросить сервер выполнить функцию. Поскольку это API, эти функции предопределены сервером и должны соответствовать предоставленной спецификации.

Запросы REST API состоят из четырех основных компонентов:

* Универсальный идентификатор ресурса (URI)
* HTTP-метод
* Заголовок
* Тело

### Универсальный идентификатор ресурса (URI)

Унифицированный идентификатор ресурса (URI) иногда называют унифицированным указателем ресурса (URL). URI определяет, каким ресурсом клиент хочет манипулировать. Запрос REST должен идентифицировать запрошенный ресурс; идентификация ресурсов для REST API обычно является частью URI.

URI по сути имеет тот же формат, что и URL-адрес, который вы используете в браузере для перехода на веб-страницу. Синтаксис состоит из следующих компонентов в указанном порядке:

* Схема
* Ресурс
* Путь
* Запрос

Когда вы собираете компоненты вместе, URI будет выглядеть так: `схема:[//ресурс][/путь][? запрос]`

![](./assets/4.4.2.png)
<!-- /courses/devnet/337c1050-b012-11ea-8a1b-c929643d7563/338add60-b012-11ea-8a1b-c929643d7563/assets/9780d9b0-bcc3-11ea-af32-dfde9d560aae.svg -->

Различные компоненты унифицированного идентификатора ресурса (URI)

### Схема

Схема определяет, какой протокол HTTP следует использовать. Для REST API есть два варианта:

* http - соединение открыто
* https - соединение безопасно

### Ресурс

Ресурс или место назначения состоят из двух частей, которым предшествуют две косые черты (`//`):

* Хост
* Порт

**Хост** - имя хоста или IP-адрес сервера, предоставляющего REST API (веб-сервис). **Порт** - конечная точка связи или номер порта, связанный с хостом. Перед портом всегда стоит двоеточие (`:`). Обратите внимание, что если сервер использует порт по умолчанию - 80 для HTTP и 443 для HTTPS - порт может быть не указан в URI.

### Путь

Для REST API путь обычно известен как путь к ресурсу и представляет собой расположение ресурса, данных или объекта, которыми нужно управлять на сервере. Путь предваряется косой чертой (`/`) и может состоять из нескольких сегментов, разделенных косой чертой (`/`).

### Запрос

Запрос, который включает параметры запроса, является необязательным. Запрос предоставляет дополнительные сведения об области действия, фильтрации или уточнении запроса. Если запрос присутствует, ему предшествует вопросительный знак (`?`). Не существует специального синтаксиса для параметров запроса, но обычно он определяется как набор пар ключ-значение, разделенных амперсандом (`&`). Например:

```
http://example.com/update/person?id=42&email=person%40example.com
```

### Метод HTTP 

API-интерфейсы REST используют стандартные методы HTTP, также известные как HTTP-глаголы, как способ сообщить веб-службе, какое действие запрашивается для данного ресурса. Не существует стандарта, который определяет, какой HTTP-метод сопоставлен с каким действием, но предлагаемое сопоставление выглядит следующим образом:

| Метод HTTP | Действие             | Описание                                            |
| ---------- | -------------------- | --------------------------------------------------- |
| **POST**   | Создание             | Создайте новый объект или ресурс.                   |
| **GET**    | Чтение               | Получить сведения о ресурсах из системы.            |
| **PUT**    | Обновление           | Заменить или обновить существующий ресурс.          |
| **PATCH**  | Частичное обновление | Обновите некоторые детали из существующего ресурса. |
| **DELETE** | Удаление             | Удалить ресурс из системы.                          |

### Заголовок

API REST используют стандартный формат заголовка HTTP для передачи дополнительной информации между клиентом и сервером, но эта дополнительная информация не является обязательной. Заголовки HTTP форматируются как пары имя-значение, разделенные двоеточием (`:`), `[имя]:[значение]`. Определены некоторые стандартные заголовки HTTP, но веб-служба, принимающая запрос REST API, может определять настраиваемые заголовки для принятия.

Есть два типа заголовков: заголовки запроса и заголовки сущностей.

### Заголовки запроса

Заголовки запроса содержат дополнительную информацию, не имеющую отношения к содержанию сообщения.

Например, вот типичный заголовок запроса, который вы можете найти для запроса REST API:

| **Ключ**          | **Пример значения**        | **Описание**                                        |
| ----------------- | -------------------------- | --------------------------------------------------- |
| **Authorization** | Basic dmFncmFudDp2YWdyYW50 | Предоставьте учетные данные для авторизации запроса |

### Заголовки объектов

Заголовки объектов - это дополнительная информация, описывающая содержимое тела сообщения.

Вот типичный заголовок объекта, который вы можете найти для запроса REST API:

| Ключ             | Пример значения  | Описание                             |
| ---------------- | ---------------- | ------------------------------------ |
| **Content-Type** | application/json | Укажите формат данных в теле запроса |

### Тело

Тело запроса REST API содержит данные, относящиеся к ресурсу, которым клиент хочет управлять. Запросы REST API, использующие HTTP-метод POST, PUT и PATCH, обычно включают тело. В зависимости от метода HTTP тело является необязательным, но если данные предоставляются в теле, тип данных должен быть указан в заголовке с помощью ключа Content-Type. Некоторые API созданы для приема нескольких типов данных в запросе.

<!-- 4.4.3 -->
## Ответы REST API

Ответы REST API по сути являются HTTP-ответами. Эти ответы сообщают результаты HTTP-запроса клиента. Ответ может содержать запрошенные данные, означать, что сервер получил свой запрос, или даже информировать клиента о том, что с его запросом возникла проблема.

Ответы REST API похожи на запросы, но состоят из трех основных компонентов:

* Статус HTTP
* Заголовок
* Тело

### Статус HTTP

API-интерфейсы REST используют стандартные коды состояния HTTP в ответе, чтобы сообщить клиенту, был ли запрос успешным или неуспешным. Код состояния HTTP может помочь клиенту определить причину ошибки, а иногда и предлагать способы ее устранения.

Коды состояния HTTP всегда состоят из трех цифр. Первая цифра - это категория ответа. Две другие цифры не имеют значения, но обычно присваиваются в числовом порядке. Есть пять разных категорий:

* **1xx** - Информационные
* **2xx** - Успешные
* **3xx** - Перенаправление
* **4xx** - Ошибка клиента
* **5xx** - Ошибка сервера

### 1xx - информационные

Ответы с кодом 1xx предназначены для информационных целей, указывая, что сервер получил запрос, но еще не завершил его обработку. Клиент должен ожидать полного ответа позже. Эти ответы обычно не содержат тела.

### 2xx - успешные

Ответы с кодом 2xx означают, что сервер получил и принял запрос. Для синхронных API эти ответы содержат запрошенные данные в теле (если применимо). Для асинхронных API-интерфейсов ответы обычно не содержат тела, а код состояния 2xx является подтверждением того, что запрос был получен, но все еще должен быть выполнен.

### 3xx - перенаправление

Ответы с кодом 3xx означают, что у клиента есть дополнительные действия, которые необходимо предпринять для выполнения запроса. В большинстве случаев необходимо использовать другой URL. В зависимости от того, как был вызван REST API, пользователь может быть автоматически перенаправлен без каких-либо действий вручную.

### 4xx - ошибка клиента

Ответы с кодом 4xx означают, что запрос содержит ошибку, например неправильный синтаксис или недопустимый ввод, что препятствует выполнению запроса. Перед повторной отправкой запроса клиент должен принять меры для устранения этих проблем.

### 5xx - ошибка сервера

Ответы с кодом 5xx означают, что сервер не может выполнить запрос, даже если сам запрос действителен. В зависимости от того, какой это конкретный код состояния 5xx, клиент может захотеть повторить запрос позже.

### Общие коды состояния HTTP

| Код состояния HTTP | Статус                    | Описание                                                                                      |
| ------------------ | ------------------------- | --------------------------------------------------------------------------------------------- |
| **200**            | В порядке                 | Запрос был успешным и обычно содержит полезные данные (тело)                                  |
| **201**            | Создано                   | Запрос был выполнен и запрошенный ресурс создан                                               |
| **202**            | Принято                   | Запрос принят в обработку и обрабатывается                                                    |
| **400**            | Плохой запрос             | Запрос не будет обработан из-за ошибки с запросом                                             |
| **401**            | Неавторизованный          | Запрос не имеет действительных учетных данных аутентификации для выполнения запроса           |
| **403**            | Запрещено                 | Запрос был принят, но отклонен сервером                                                       |
| **404**            | Не обнаружен              | Запрос не может быть выполнен, потому что путь к ресурсу запроса не был найден на сервере     |
| **500**            | Внутренняя ошибка сервера | Запрос не может быть выполнен из-за ошибки сервера                                            |
| **503**            | Сервис недоступен         | Запрос не может быть выполнен, потому что в настоящее время сервер не может обработать запрос |

Вы можете получить подробную информацию о каждом коде состояния HTTP из официального реестра кодов состояния HTTP, который ведется Internet Assigned Numbers Authority (IANA). В реестре также указывается, какие значения не присвоены.

### Заголовок

Заголовок ответа, как и запрос, также использует стандартный формат заголовка HTTP и также является необязательным. Заголовок ответа должен предоставлять дополнительную информацию между сервером и клиентом в формате пары имя-значение, разделенном двоеточием (`:`), `[имя]: [значение]`.

Есть два типа заголовков: заголовки ответов и заголовки объектов.

### Заголовки ответа

Заголовки ответа содержат дополнительную информацию, не имеющую отношения к содержанию сообщения.

Вот некоторые типичные заголовки ответа, которые вы можете найти на запрос REST API:

| Ключ              | Пример значения                     | Описание                                                                     |
| ----------------- | ----------------------------------- | ---------------------------------------------------------------------------- |
| **Set-Cookie**    | JSESSIONID=30A9DN810FQ428P; Path=/  | Используется для отправки файлов cookie с сервера                            |
| **Cache-Control** | Cache-Control: max-age=3600, public | Укажите директивы, которые ДОЛЖНЫ выполняться всеми механизмами кэширования. |

### Заголовки объектов

Заголовки объектов - это дополнительная информация, описывающая содержимое тела сообщения.

Один общий заголовок объекта определяет тип возвращаемых данных:

| Ключ             | Пример значения  | Описание                     |
| ---------------- | ---------------- | ---------------------------- |
| **Content-Type** | application/json | Укажите формат данных в теле |

### Тело

Тело ответа REST API - это данные, запрошенные клиентом в запросе REST API. Тело необязательно, но если данные предоставлены в теле, тип данных указывается в заголовке с помощью ключа  `Content-Type`. Если запрос REST API был неудачным, тело может предоставить дополнительную информацию о проблеме или действии, которое необходимо предпринять для успешного выполнения запроса.

### Пагинация ответа

Некоторым API, таким как API поиска, может потребоваться отправить в ответ огромное количество данных. Чтобы уменьшить использование полосы пропускания в сети, эти API будут разбивать данные ответа на страницы.

Разбиение на страницы ответа позволяет разбивать данные на части. Большинство API-интерфейсов, реализующих разбиение на страницы, позволяют запрашивающей стороне указать, сколько элементов они хотят в ответе. Поскольку существует несколько фрагментов, API также должен позволять запрашивающей стороне указывать, какой фрагмент ему нужен. Для API не существует стандартного способа реализации разбивки на страницы, но большинство реализаций используют параметр запроса, чтобы указать, какую страницу возвращать в ответе. Взгляните на документацию API, чтобы получить подробную информацию о разбивке на страницы для конкретного API, который вы используете.

### Сжатые данные ответа

Когда серверу необходимо отправить очень большие объемы данных, которые невозможно разбить на страницы, сжатые данные - еще один способ уменьшить полосу пропускания.

Это сжатие данных может быть запрошено клиентом через сам запрос API. Чтобы запросить сжатие данных, запрос должен добавить поле `Accept-Encoding` в заголовок запроса. Допустимые значения:

* gzip
* compress
* deflate
* br
* identity
* *

Если сервер не может предоставить ни один из запрошенных типов сжатия, он отправит ответ с кодом состояния `406 -- Not acceptable`.

Если сервер выполняет сжатие, он отправит ответ со сжатыми данными и добавит поле `Content-Encoding` в заголовок ответа. Значение `Content-Encoding` - это тип сжатия, который использовался, позволяя клиенту правильно распаковать данные.

<!-- 4.4.4 -->
## Использование диаграмм последовательностей с REST API

Диаграммы последовательности используются для объяснения последовательности обменов или событий. Они предоставляют сценарий упорядоченного набора событий. Их также называют диаграммами событий. Хотя один запрос REST API может служить для получения информации или инициирования изменений в системе, чаще всего взаимодействие с конкретной службой REST API будет представлять собой последовательность запросов. По этой причине диаграммы последовательности часто используются для объяснения запроса/ответа REST API и асинхронной активности.

Формализованные диаграммы последовательности тесно связаны и считаются подмножеством стандартизированной системы моделирования, известной как Unified Modeling Language (UML). UML включает стандартизованные подходы к другим аспектам статических ресурсов и процессов, в том числе стандартизированные способы построения диаграмм и объяснения пользовательских интерфейсов, определений классов и объектов, а также поведения взаимодействия. Диаграммы последовательности - это один из способов диаграмм поведения взаимодействия.

На стандартной диаграмме последовательности, такой как приведенная ниже, по оси Y упорядочено немасштабированное время с нулевым временем (t\=0) вверху, а время увеличивается к низу. Если стрелка или обмен внизу на диаграмме, это происходит после тех, что вверху.

Ось X состоит из линий жизни, представленных вертикальными линиями с заголовками, и обменов или сообщений, представленных горизонтальными стрелками. Линия жизни - это любой элемент, который может взаимодействовать, получая или создавая сообщение. По соглашению, внешние инициаторы последовательности, такие как пользователь, клиент или веб-браузер, помещаются в левой части диаграммы. Такие элементы, как файловые системы, базы данных, постоянное хранилище и т. д., размещаются справа. Промежуточные службы, такие как веб-сервер или конечные точки API, расположены посередине.

Одним из полезных аспектов диаграмм последовательностей является то, что пользователи диаграмм могут сосредоточиться на взаимодействии только между двумя элементами жизненного пути. Например, в то время как остальная часть диаграммы может помочь установить контекст, пользователи REST API могут сосредоточиться на взаимодействии между клиентом и интерфейсом, или, как показано ниже, **Обработчик конечных точек Host HTTP/S Service API**.

В приведенной ниже последовательности API показаны три упрощенных сценария.

### Диаграмма последовательности запросов/ответов API

![](./assets/4.4.4.png)
<!-- /courses/devnet/337c1050-b012-11ea-8a1b-c929643d7563/338add60-b012-11ea-8a1b-c929643d7563/assets/9780d9b1-bcc3-11ea-af32-dfde9d560aae.svg -->

Клиент слева может быть приложением со сценарием Python, тестовой средой POSTMAN или любым другим генератором запросов API. Клиент отправит запрос в формате HTTPS на интерфейс сервера, названный здесь **Обработчик конечных точек Host HTTP/S Service API**. Этот компонент обычно передает запрос соответствующему обработчику API, который называется **Службы API**. Справа от служб API находится элемент с простым названием **Ядро**, который является универсальным для логики или платформы первичной обработки.

Службы API могут обрабатывать некоторые запросы напрямую или могут интерпретировать, а затем пересылать часть или весь запрос на **Ядро**. Крайний правый столбец, показанный здесь как **База данных конфигурации**, может быть любое постоянное хранилище - или даже процесс обмена сообщениями или постановки в очередь для связи с другой системой.

В этом примере показаны три отдельные последовательности: создание сеанса, получение устройств и создание устройства.

**Создать сеанс**: Начальный запрос помечен **HTTPS: создать сеанс с учетными данными**. Здесь логика создания сеанса HTTPS находится во внешнем обработчике конечной точки Host HTTP/S Service API. (Это показано графически с помощью возвращающейся назад стрелки.)

**Получить устройства**: Второй запрос от клиента - запросить список устройств у платформы. В этой последовательности запрос пересылается в модуль служб API, который затем содержит логику для непосредственного запроса базы данных конфигурации, получения списка устройств и возврата списка обработчику конечной точки. Затем обработчик упаковывает содержимое в ответ HTTPS и возвращает его клиенту вместе с кодом состояния HTTP, указывающим на успех.

Эти первые две последовательности демонстрируют синхронный обмены, в которых за запросом следует ответ, а задача полностью завершена с успехом или неудачей.

**Создать устройство**: Третья последовательность начинается с запроса POST для создания устройства. В этом случае запрос переносится на **Службы API**, который затем перенаправляет запрос в логику **Ядра**, которая затем начинает работать по запросу. **Службы API** ждут только сообщения от **Ядра** в подтверждение того, что процесс создания устройства начался. **Ядро** предоставляет дескриптор (TaskId), который идентифицирует работу и позволяет отслеживать, была ли работа завершена. Значение TaskId передается в ответ обратно клиенту. Ответ HTTP сообщает клиенту только дескриптор (TaskId) и что запрос был инициирован с кодом ответа 202 (Принято). Это означает, что запрос был принят, и что сейчас работа ведется.

Логика **Ядра** продолжает выполняться. Она обновляет **Базу данных конфигурации**, а затем информирует **Службы API** когда он будет завершен. Некоторое время спустя клиент может подтвердить, что задача выполнена. Клиент делает это с помощью запроса статуса задачи. **Службы API** затем может ответить, предоставив информацию о статусе завершения и статусе успеха или неудачи для этой задачи. Поскольку фактическая запрошенная работа не была завершена до ответа клиенту, это взаимодействие считается асинхронным.
